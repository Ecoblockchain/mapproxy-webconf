%def leftblock():
<div ng-controller="MapproxyLayerListCtrl">
   <button class="btn btn-small btn-info pull-right" ng-click="newLayer()">
        <span class="icon-plus-sign icon-white" ></span>
    New layer</button>
   <button class="btn btn-small btn-success pull-right" ng-click="updateLayerTree()" style="margin-right:1em;">Save</button>

  <h3>Layer</h3>
   <script type="text/ng-template"  id="mapproxy_layer_renderer.html">
    <ul sortable ng-model="layer._layers">
      <li ng-repeat="layer in layer._layers | orderBy:'_rank'">  <!-- new scope -->
      <!-- new scope -->
      <!-- need to access layer._layers from 2 lines above so i have to go 2 scopes up ($parent.$parent) -->
        <div ng-click="editLayer(layer)">{{layer.name}} ({{layer.title}})
          <i class="icon-remove"
            ask-dialog
            dialog-title="Confirm!"
            dialog-text='Really remove layer "{{layer.title}} ({{layer.name}})"?'
            callback="removeLayer(layer)"></i>
            <div
              ng-include="'mapproxy_layer_renderer.html'"
              style="margin-left: 0.5em"
            >
        </div>
      </li>
    </ul>
    </script>
    <div>
      <ul sortable ng-model="mapproxy_layers" class="vertical-list">
        <hr>
        <div class="{{isSelected(layer)}}"
          ng-repeat="layer in mapproxy_layers | orderBy:'_rank'"
          ng-click="editLayer(layer)">
          <li>
            {{layer.title}} ({{layer.name}})
            <i class="icon-remove pull-right"
              ask-dialog
              dialog-title="Confirm!"
              dialog-text='Really remove layer "{{layer.title}} ({{layer.name}})"?'
              callback="removeLayer(layer)"></i>
<!--               <div
                ng-include="'mapproxy_layer_renderer.html'"
                style="margin-left: 0.5em"
                sortable
                ng-model="layer._layers"
              >
              </div> -->
          </li>
          <hr>
        </div>
      </ul>
    </div>

   <div class="text-success" id="layertree_save_ok" ng-show="false">
    <i class="icon-ok"></i>
    <strong>Saved successfully</strong>
   </div>

</div>
%end

%def middleblock():
<div ng-controller="MapproxyLayerFormCtrl">
  <form name="layer_form" ng-model="layer">
    <h3>{{formTitle}}</h3>
    <!-- name -->
        <div labeled="input_label" name-for="layer_form.layer_name" text="Name">
            <input required type="text" required ng-model="layer.name" class="input-xlarge" id="layer_form.layer_name"/>
        </div>
    <!-- title -->
        <div labeled="input_label" name-for="layer_form.layer_title" text="Title">
            <input required type="text" required ng-model="layer.title" class="input-xlarge" id="layer_form.layer_title"/>
        </div>
    <!-- sources -->
        <div labeled="input_label" name-for="layer_form.sources" text="Sources">
            <div
                droppable
                sortable
                required
                accepts="mapproxy_source,mapproxy_cache"
                allow-array="true"
                ng-model="layer.sources"
                id="layer_sources"
                use-key-for-value="_id"
                class="input-xlarge insertable-list uneditable-input">
                <div ng-repeat="source in layer.sources" class="label">
                    <span ng-bind="showName(source)"></span>
                     <i class="icon-remove" ng-click="remove(source)"></i>
                </div>
            </div>
        </div>
    </form>
    <button class="btn btn-small" ng-click="addLayer()" ng-disabled="!layer_form.$valid">Save</button>
    <button class="btn btn-small" ng-click="resetForm()">Reset</button>
    <span class="text-success" id="layer_save_ok" ng-show="false">
      <i class="icon-ok"></i>
      <strong>Saved successfully</strong>
    </span>

</div>
%end

%def rightblock():
  <div>
      <h3>Sources</h3>
      <ul class="vertical-list" ng-controller="MapproxySourceListCtrl">
          <div
              draggable
              class="mapproxy_source"
              ng-repeat="source in mapproxy_sources | orderBy:'name'"
              item-data="{{source}}">
              <li class="droppable_name"> {{source.name}}</li>
              <hr>
            </div>
      </ul>
      <hr>
      <h3>Caches</h3>
      <ul class="vertical-list" ng-controller="MapproxyCacheListCtrl">
          <div
              draggable
              class="mapproxy_cache"
              ng-repeat="cache in mapproxy_caches | orderBy:'name'"
              item-data="{{cache}}">
              <li class="droppable_name">{{cache.name}}</li>
              <hr>
          </div>
      </ul>
    </div>
%end
%rebase base_config leftblock=leftblock, rightblock=rightblock, middleblock=middleblock,  project=get('project'),  active='layers'