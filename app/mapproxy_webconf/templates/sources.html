%def preload_block():
  var preloaded_wms_capabilities = ${!wms_capabilities};
  var preloaded_sources = ${!sources};
  var preloaded_caches = ${!caches};
  var preloaded_defaults = ${!defaults};
%end

%def jsblock():
  <script type="text/javascript" src="${ get_url('static', filepath='js/min_max_res_helper.js') }"></script>
%end

%def leftblock():
  <div ng-controller="SourceListCtrl">
    <div class="pull-right">
      <!-- konflikt mit bootstrap -->
      <button class="btn btn-small btn-add pull-right" ng-click="newItem()">
        <span class="icon-plus-sign icon-white" ></span>
        ${ _('Create new source') }
      </button>
    </div>
    <h3>${ _('Sources') }</h3>
    <span message-handler="success"
          message-types="sources.delete_success">
    </span>
    <span message-handler="error"
          message-types="sources.load_error,sources.delete_error">
    </span>
    <div>
      <input type="text" ng-model="search" placeholder="${ _('Filter') }..." class="input-large"/>
      <span ng-show="list.length - filtered.length" ng-click="search=''">
        ${ _('Not shown sources') }: {{list.length - filtered.length}}
      </span>
    </div>
    <ul class="vertical-list">
      <div class="{{isSelected(item)}}"
           ng-repeat="item in filtered = (list | filter: {data.name:search})"
           ng-click="editItem($event, item)">
        <li>
          <i ng-show="item._manual" class="icon-pencil"></i>
          {{item.data.name}}
          <i class="icon-remove"
            dialog="ask"
            dialog-title="${ _('Confirm!') }"
            dialog-text="${ _('Really remove source') }: {{item.data.name}}?"
            callback="removeItem($event, item)">
          </i>
           <i class="icon-share" ng-click="copyItem($event, item)"></i>
        </li>
      </div>
    </ul>
    <!-- need to updated filtered after ng-repeat is finished -->
    <span ng-show="false">{{filtered.length}}</span>
  </div>
%end

%def middleblock():
  <div ng-controller="MapproxySourceFormCtrl"
       ng-init="custom.scalesToResURL='${get_url('scales_to_res')}';custom.resToScalesURL='${get_url('res_to_scales')}';">
    <form name="form" novalidate ng-show="!editareaBinds.visible">
      <h3 ng-show="formTitle=='new'">${ _('New source') }</h3>
      <h3 ng-show="formTitle=='edit'">${ _('Edit source') }</h3>
      <fieldset>
        <div toggle-group mode="multiShow">
          <!-- title? -->
          <div style="display:none;"
               id="confirm_layer_change_dialog"
               title="${ _('Confirm!') }">
            <p>${ _('Replace layer - replaces also the service url') }</p>
          </div>
          <div style="display:none;"
               id="confirm_url_change_dialog"
               title="${ _('Confirm!') }">
            <p>${ _('Replace service URL deletes all layers depends to it!') }</p>
          </div>
          <div ng-show="true">
            <div labeled="input_label" name-for="name" text="${ _('Name') }">
              <input class="input-xlarge"
                     type="text"
                     required
                     ng-model="source.data.name"
                     id="name"
                     name="name"/>
            </div>
            <div id="source_wms_url" labeled="input_label" name-for="req_url" text="${ _('URL') }">
              <input id="req_url"
                     name="req_url"
                     class="input-xlarge"
                     type="url"
                     value="{{source.data.wms_source}}"
                     ng-model="source.data.req.url"
                     required
                     droppable
                     change-callback="openDialog(callback, new_data)"
                     accepts="wms_source"
                     use-key-for-value="data.url"/>
            </div>
            <div labeled="input_label" name-for="req_layers" text="${ _('Layer') }" >
              <div droppable
                   sortable
                   required
                   accepts="wms_layer"
                   allow-array="true"
                   ng-model="source.data.req.layers"
                   name="req_layers"
                   id="req_layers"
                   use-key-for-value="name"
                   class="input-xlarge insertable-list uneditable-input"
                   insert-callback="checkURL(callback, new_data)">
                <div ng-repeat="layer in source.data.req.layers" class="label">
                  {{layer}}
                  <span ng-show="layerTitle(layer)">({{layerTitle(layer)}})</span>
                  <i class="icon-remove" ng-click="remove(layer)"></i>
                </div>
              </div>
            </div>
            <div class="input-append"
                 labeled="input_label"
                 name-for="add_layer_manual"
                 text="${ _('Manual add layer') }">
              <input type="text"
                     id="add_layer_manual"
                     name="add_layer_manual"
                     ng-model="custom.layer_manual"
                     class="input-medium"
                     unique="{{source.data.req.layers}}"/>
              <button class="btn btn-small"
                      ng-click="addLayerManual($event)"
                      ng-disabled="!custom.layer_manual">
                ${ _('Add') }
              </button>
            </div>
            <hr class="formLine">
            <div labeled='checkbox_label'
                 name-for="req_transparent"
                 text="${ _('Transparency') }"
                 warning="{{warningLogic.checkImageSettings()}}"
                 warning-msg="${ _('Selectet image format(s) not support transparency.') }">
              <input type="checkbox"
                     ng-model="source.data.req.transparent"
                     id="req_transparent"
                     name="req_transparent"/>
            </div>
            <div labeled="input_label"
                 name-for="supported_formats"
                 text="${ _('Supported formats') }"
                 warning="{{warningLogic.checkImageSettings()}}"
                 warning-msg="${ _('Selectet image format(s) not support transparency.') }">
              <select name="supported_formats"
                      id="supported_formats"
                      multiple="multiple"
                      ng-model="source.data.supported_formats">
                <option value="PNG">PNG</option>
                <option value="JPEG">JPEG</option>
                <option value="GIF">GIF</option>
              </select>
              <button class="btn btn-small"
                      ng-click="source.data.supported_formats=undefined;">
                ${ _('Clear selection') }
              </button>
            </div>
            <hr class="formLine">
            <div labeled='input_label_toggleable'
                 name-for="bbox_3"
                 text="${ _('Coverage BBOX') }">
              <div class="text-center">
                <input type="number"
                       placeholder="${ _('North') }"
                       float
                       ng-model="source.data.coverage.bbox[3]"
                       class="input-large"
                       id="bbox_3"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_3"/>
                <br>
                <input type="number"
                       placeholder="${ _('West') }"
                       float
                       ng-model="source.data.coverage.bbox[0]"
                       class="input-large"
                       id="bbox_0"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_0"/>
                <input type="number"
                       placeholder="${ _('East') }"
                       float
                       ng-model="source.data.coverage.bbox[2]"
                       class="input-large"
                       id="bbox_2"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_2"/>
                <br>
                <input type="number"
                       placeholder="${ _('South') }"
                       float
                       ng-model="source.data.coverage.bbox[1]"
                       class="input-large"
                       id="bbox_1"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_1"/>
              </div>
              <button class="btn btn-small"
                      ng-disabled="!source.data.req.url"
                      ng-click="addCoverage($event)"
                      id="form_load_coverage">
                ${ _('Use coverage from WMS') }
              </button>
              <div labeled="input_label" name-for="coverage_srs" text="${ _('Coverage SRS') }">
                <select class="input-xlarge"
                        ng-model="source.data.coverage.srs"
                        id="coverage_srs"
                        name="coverage_srs"
                        ng-change="fillBBox()"
                        ng-options="srs for srs in defaults.data.srs">
                </select>
              </div>
              <button class="btn btn-small"
                      ng-click="showCoverageInMap()"
                      ng-disabled="!isEmptyBBox() && !validBBox()">
                <span ng-show="!isEmptyBBox()">${ _('Show coverage in map') }</span>
                <span ng-show="isEmptyBBox()">${ _('Create coverage in map') }</span>
              </button>
              <span message-handler="error"
                    message-types="olMap.showMap_error">
              </span>
            </div>
            <hr class="formLine">
            <div labeled="input_label_toggleable" name-for="supported_srs" text="${ _('Supported SRS') }">
              <button class="btn btn-small pull-right"
                      ng-click="loadSRS($event)"
                      ng-disabled="!source.data.req.url">
                ${ _('Add SRS from WMS') }
              </button>
              <div name="supported_srs" id="supported_srs" class="well well-small input-large">
                <span class="badge" ng-repeat="srs in source.data.supported_srs">
                  {{srs}}
                  <i class="icon-remove" ng-click="removeSRS($event, srs)"></i>
                </span>
              </div>
              <div class="input-append"
                   labeled="input_label"
                   name-for="add_srs_manual"
                   text="${ _('Manual add SRS') }">
                <input type="text"
                       id="add_srs_manual"
                       name="add_srs_manual"
                       ng-model="custom.srs_manual"
                       class="input-medium"/>
                <button class="btn btn-small"
                        ng-click="addSRSManual($event)"
                        ng-disabled="!custom.srs_manual">
                  ${ _('Add') }
                </button>
              </div>
            </div>
            <hr class="formLine">
            <div ng-include src="'${ get_url('angular_template', filename='min_max_res') }'"></div>
        <hr class="formLine">
        <div class="pull-left">
          <button class="btn btn-small"
                  ng-click="addSource($event)"
                  ng-disabled="!form.$valid"
                  id="form_save"
                  ng-class="{'btn-success': form.$valid}">
            ${ _('Save') }
          </button>
          <button class="btn btn-small" ng-click="resetForm($event)">${ _('Reset') }</button>
        </div>
        <div id="_editarea_toggle_button_container" class="pull-right">
        </div>
      </fieldset>
      <div ol-map="olmapBinds"
           map-width="1000"
           map-height="600"
           map-hidden="true"
           map-layer-switcher="true"
           map-toolbar="true">
      </div>
    </form>
    <div editarea="editareaBinds"
         yaml-URL="${get_url('json_to_yaml')}"
         json-URL="${get_url('yaml_to_json')}"
         keep-empty-fields="name"></div>
    <div message-handler="success"
         message-types="sources.add_success,sources.update_success">
    </div>
    <div message-handler="error"
         message-types="sources.add_error,sources.update_error,sources.form_error">
    </div>
  </div>
%end

%def rightblock():
  <div ng-controller="TreeCtrl">
    <h3>${ _('Available WMS') }</h3>
    <script type="text/ng-template"  id="wms_layer_renderer">
      <div ng-click="show_infos(layer)" class="label droppable_name">
        <i class="icon-plus pull-left"
           ng-show="layer.layers && layer.layers.length > 0 && !layer.expanded"
           ng-click="layer.expanded=true;">
        </i>
        <i class="icon-minus pull-left"
           ng-show="layer.layers && layer.layers.length > 0 && layer.expanded"
           ng-click="layer.expanded=false;">
        </i>
        {{layer.title}} – <span ng-show="layer.name">{{layer.name}}</span>
      </div>
      <span ng-show="layer.expanded">
        <div ng-repeat="layer in layer.layers"
             ng-include="'wms_layer_renderer'"
             draggable
             item-data="{{prepareItemData(layer)}}"
             ng-show="(layer.name || layer.layers)"
             ng-class="{'grp_layer': layer.layers}"
             class="wms_layer">
        </div>
        <!-- wms_layer is required for dropping into droppable -->
      </span>
    </script>
    <div toggle-group mode='hideOther' class="accordion">
      <div ng-repeat="wms in wms_list" class="wms accordion-group">
        <div class="accordion-heading" toggle-element="next">
          <div class="accordion-toggle">{{wms.data.title}}</div>
          <i class="icon-globe" ng-click="showMap($event, wms)"></i>
          <i class="icon-refresh"  ng-click="refreshCapabilities($event, wms)"></i>
          <i class="icon-remove"
             dialog="ask"
             dialog-title="${ _('Confirm!') }"
             dialog-text="${ _('Really remove WMS:') } {{wms.data.title}}?"
             callback="removeCapabilities(wms)">
          </i>
        </div>
        <div class="accordion-body" ng-show="isOpen()">
          <div class="accordion-inner">
            <h6>${ _('Infos') }</h6>
            <div class="accordion_wms_source wms_source" draggable item-data="{{wms}}">
              <div class="droppable_name label">
                ${ _('URL') }: {{wms.data.url}}
              </div>
            </div>
            <h6>${ _('Layers') }</h6>
            <div ng-repeat="layer in wms.data.layer.layers"
                 ng-include="'wms_layer_renderer'"
                 draggable item-data="{{prepareItemData(layer)}}"
                 ng-show="layer.name || layer.layers"
                 ng-class="{'grp_layer': layer.layers}"
                 class="wms_layer">
            </div>
            <!-- wms_layer is required for dropping into droppable -->
          </div>
        </div>
      </div>
    </div>
    <div message-handler="success"
         message-types="wms_capabilities.delete_success,wms_capabilities.update_success">
    </div>
    <div message-handler="error"
         message-types="wms_capabilities.load_error,wms_capabilities.delete_error,wms_capabilities.update_error">
    </div>
    <div spinner='wms_capabilities'>
        <img src="${ get_url('static', filepath='img/loader.gif') }"> ${ _('Loading in progress') }
    </div>
    <hr>
    <form name="form" novalidate>
      <div class="input-append" labeled="input_label" name-for="url"  text="${ _('Load WMS') }">
        <input type="url" required name="url" ng-model="capabilities.url" id="url" unique="{{wms_urls}}">
        <button class="btn btn-small" ng-click="addCapabilities()" ng-disabled="!form.$valid">${ _('Add') }</button>
      </div>
      <div message-handler="success" message-types="wms_capabilities.add_success"></div>
      <div message-handler="error" message-types="wms_capabilities.add_error"></div>
    </form>
    <div ol-map="olmapBinds" map-width="1000" map-height="600" map-hidden="true" map-layer-switcher="true"></div>
  </div>
%end
%rebase base_config leftblock=leftblock, rightblock=rightblock, middleblock=middleblock, jsblock=jsblock, preload_block=preload_block, project=get('project'),  active='sources'
