%def preload_block():
  var preloaded_grids = ${!grids};
  var preloaded_defaults = ${!defaults};
%end

%def leftblock():
  <div ng-controller="GridListCtrl">
    <h4>
      ${ _('User defined grids') }
      <i class="glyphicon glyphicon-question-sign help"
         tooltip="grids_list"></i>
    </h4>
    <div class="pull-right form-line-spacing">
      <button class="btn btn-xs btn-add pull-right"
              ng-click="newItem()">
        <span class="glyphicon glyphicon-plus-sign" ></span>
        ${ _('Create new grid') }
      </button>
    </div>
    <span message-handler="success"
          message-types="grids.delete_success,grids.copy_success"></span>
    <span message-handler="error"
          message-types="grids.load_error,grids.delete_error"></span>
    <div>
      <div class="row">
        <div class="col-sm-10">
          <input type="text"
                 ng-model="search"
                 placeholder="${ _('Filter') }..."
                 class="form-control input-sm" />
        </div>
        <div class="col-sm-2 filter-help-col">
          <i class="glyphicon glyphicon-question-sign help pull-left"
             tooltip="filter"></i>
        </div>
      </div>
      <span ng-show="list.length - filtered.length"
            ng-click="search=''"
            class="filtered-items-text">
        ${ _('Not shown grids') }: {{list.length - filtered.length}}
      </span>
    </div>
    <div class="form-line-spacing">
      <ul class="vertical-list">
        <div class="{{isSelected(item)}}"
              ng-repeat="item in filtered = (list | filter: {data.name:search}) | orderBy:'name'"
              ng-click="editItem($event, item)">
          <li>
            <i ng-show="item._manual"
               class="glyphicon glyphicon-pencil list-icon"
               title="${_('edit manual')}"></i>
            <i ng-show="item._locked || item.default"
               class="glyphicon glyphicon-ok list-icon"></i>
            {{item.data.name}}
            <i class="glyphicon glyphicon-remove pull-right list-icon"
              dialog="ask"
              dialog-title="${ _('Confirm!') }"
              dialog-text="${ _('Really remove grid:') } {{item.data.name}}?"
              callback="removeItem($event, item)"
              title="${_('delete')}">
            </i>
            <i class="glyphicon glyphicon-share pull-right list-icon"
               ng-click="copyItem($event, item)"
               title="${_('copy')}"></i>
          </li>
        </div>
      </ul>
    </div>
    <h4 class="inline">${ _('Default grids') }</h4>
    <i class="glyphicon glyphicon-question-sign help"
       tooltip="grids_default_list"></i>
    <ul class="vertical-list">
      <div class="{{isSelected(item)}}"
           ng-repeat="item in defaultGrids | orderBy:'name'"
           ng-click="editItem($event, item)">
        <li>
          {{item.data.name}}
          <i class="glyphicon glyphicon-share pull-right list-icon"
             ng-click="copyItem($event, item)"
             title="${_('copy')}"></i>
        </li>
      </div>
    </ul>
    <span ng-show="false">{{filtered.length}}</span>
  </div>
%end

%def middleblock():
  <div ng-controller="MapproxyGridFormCtrl"
       ng-init="calculateTilesURL='${ get_url('calculate_tiles') }';transformBBoxURL='${ get_url('transform_bbox') }';checkGridParameterURL='${ get_url('validate_grid_params') }';">
    <div ng-show="!editareaBinds.visible">
      <h3 ng-show="formTitle=='new'">${ _('New grid') }</h3>
      <h3 ng-show="formTitle=='edit'">${ _('Edit grid') }</h3>
      <h3 ng-show="formTitle=='default'">${ _('Default grid') }</h3>
      <form name="form"
            id="form"
            novalidate>
        <!-- name -->
        <div labeled="input_label"
             name-for="name"
             text="${ _('Name') }"
             tooltip-content="grid_name">
          <input required
                 type="text"
                 ng-model="grid.data.name"
                 id="name"
                 ng-disabled="grid._locked||grid.default"
                 name="name"
                 class="form-control input-sm"/>
        </div>
        <!-- SRS -->
        <div labeled="input_label"
             name-for="srs"
             text="${ _('SRS') }"
             tooltip-content="grid_srs">
          <select class="form-control input-sm"
                  ng-model="grid.data.srs"
                  id="srs"
                  ng-options="srs for srs in defaults.data.srs"
                  ng-disabled="grid._locked||grid.default"
                  name="srs">
          </select>
        </div>
        <hr class="formLine">
        <!-- BBox -->
        <div labeled="input_label"
             name-for="bbox"
             text="${ _('BBox') }"
             tooltip-content="grid_bbox">
          <div class="text-center" ng-model="grid.data.bbox" list="4" name="bbox">
            <div class="row">
              <div class="col-sm-4 col-sm-offset-4">
                <input type="number"
                       placeholder="${ _('North') }"
                       float
                       ng-model="grid.data.bbox[3]"
                       class="form-control input-sm"
                       id="bbox_3"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_3"/>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-4 col-sm-offset-1">
                <input type="number"
                       placeholder="${ _('West') }"
                       float
                       ng-model="grid.data.bbox[0]"
                       class="form-control input-sm"
                       id="bbox_0"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_0"/>
              </div>
              <div class="col-sm-4 col-sm-offset-2">
                <input type="number"
                       placeholder="${ _('East') }"
                       float
                       ng-model="grid.data.bbox[2]"
                       class="form-control input-sm"
                       id="bbox_2"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_2"/>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-4 col-sm-offset-4">
                <input type="number"
                       placeholder="${ _('South') }"
                       float
                       ng-model="grid.data.bbox[1]"
                       class="form-control input-sm"
                       id="bbox_1"
                       ng-disabled="grid._locked||grid.default"
                       name="bbox_1"/>
              </div>
            </div>
          </div>
        </div>
        <!-- BBox SRS -->
        <div labeled="input_label"
             name-for="bbox_srs"
             text="${ _('BBox SRS') }"
             tooltip-content="grid_bbox_srs">
          <select class="form-control input-sm"
                  ng-model="grid.data.bbox_srs"
                  id="bbox_srs"
                  ng-options="srs for srs in defaults.data.srs"
                  ng-disabled="grid._locked||grid.default"
                  ng-change="fillBBox()"
                  name="bbox_srs">
          </select>
        </div>
        <hr>
        <button class="btn btn-sm btn-default"
                ng-click="calculateTiles(!custom.resSelected)"
                ng-disabled="!grid.data.srs">
          ${ _('Calculate tiles') }
          <i class="glyphicon glyphicon-question-sign help"
             tooltip="grid_calculate_tiles"></i>
        </button>
        <hr>
        <!-- origin -->
        <div labeled='input_label_toggleable'
             name-for="origin"
             text="${ _('Origin') }"
             tooltip-content="grid_origin">
          <select class="form-control input-sm"
                  ng-model="grid.data.origin"
                  id="origin"
                  ng-disabled="grid._locked||grid.default"
                  name="origin">
            <option value="sw">SW / LL</option>
            <option value="nw">NW / UL</option>
          </select>
        </div>
        <hr>
        <div res-scales="grid.data" mode="list" parent-form="form" dpi="defaults.data.dpi"></div>
        <hr class="formLine">
        <div labeled="input_label"
             name-for="map_srs"
             text="${ _('Map SRS') }">
          <select class="form-control input-sm"
                  ng-options="srs for srs in defaults.data.srs"
                  noop
                  id="map_srs"
                  name="map_srs"
                  ng-model="custom.mapSRS">
          </select>
          <button class="btn btn-sm btn-default"
                  ng-click="showMap($event)"
                  ng-disabled="!allowMap()">
            ${ _('Show map') }
          </button>
          <span message-handler="error"
                message-types="olMap.showMap_error">
          </span>
        </div>
        <hr class="formLine">
        <!-- buttons -->
        <div class="pull-left">
          <button class="btn btn-sm btn-default"
                  ng-click="addGrid($event)"
                  ng-disabled="grid._locked||grid.default||!form.$valid||form.$pristine"
                  id="form_save"
                  ng-class="{'btn-success': form.$valid&&!grid._locked&&!form.$pristine}">
            ${ _('Save') }
          </button>
          <button class="btn btn-sm btn-default"
                  ng-click="resetForm($event)"
                  ng-disabled="grid._locked||grid.default">
            ${ _('Reset') }
          </button>
        </div>
        <div id="_editarea_toggle_button_container"
             class="pull-right"
             ng-show="!grid._locked&&!grid.default">
        </div>
      </form>
    </div>
    <div editarea="editareaBinds"
         ng-disabled="grid._locked||grid.default"
         yaml-URL="${get_url('json_to_yaml')}"
         json-URL="${get_url('yaml_to_json')}"
         keep-empty-fields="name">
    </div>
    <div class="clear">
      <span message-handler="success"
            message-types="grids.add_success,grids.update_success">
      </span>
      <span message-handler="error"
            message-types="grids.add_error,grids.update_error,grids.form_error">
      </span>
    </div>
    <hr class="formLine">
    <button class="pull-right btn btn-sm btn-warning"
            dialog="ask"
            dialog-title="${ _('Really lock the grid') }: {{grid.data.name}}?"
            dialog-text="${ _('If you lock the grid, you won\'t be able to edit it again') }"
            callback="lockGrid()"
            ng-disabled="form.$dirty||editareaBinds.dirty"
            ng-show="!(grid._locked||grid.default)"
            id="form_lock">
      ${ _('Lock') }
    </button>
    <button class="btn btn-sm btn-default"
            ng-show="grid._locked"
            dialog="ask"
            dialog-title="${ _('Unlock') }?"
            dialog-text="${ _('If you unlock this grid it you need to check settings of all caches you use this grid and delete all affacted caches from disk') }"
            callback="unlockGrid()">
      ${ _('Unlock') }
    </button>
    <div ol-map="olmapBinds" map-hidden="true">
      <div ol-grid-extension="provideGridData" ol-grid-scales="custom.grid_scales"></div>
    </div>
  </div>
%end

%def rightblock():
  <div ng-controller="DisplayCalculatedTilesCtrl">
    <button class="btn btn-sm btn-default pull-right"
            ng-click="refresh()"
            ng-show="calculatedTiles">${ _('Refresh') }</button>
    <br ng-show="calculatedTiles">
    <hr ng-show="calculatedTiles">
    <table class="table"
           ng-show="calculatedTiles">
      <thead>
        <tr>
          <th class="text-left">${ _('Level') }</th>
          <th class="text_center">
            <div class="btn-group" data-toggle="buttons-radio" style="display: inline-block;">
              <button type="button"
                      class="btn btn-sm btn-default"
                      ng-class="{'active': resSelected}"
                      ng-click="resSelected=true;">
                ${ _('Resolution') }
              </button>
              <button type="button"
                      class="btn btn-sm btn-default"
                      ng-class="{'active': !resSelected}"
                      ng-click="resSelected=false;">
                ${ _('Scale') }
              </button>
            </div>
          </th>
          <th class="text-right">${ _('Total tiles') }</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="row in calculatedTiles | orderBy:'level'">
          <td class="text-left">{{row.level}}</td>
          <td ng-show="resSelected"
              class="text-left">
            {{row.resolution | number:9}}
          </td>
          <td ng-show="!resSelected"
              class="text-right">
            1 : {{row.scale | number}}
          </td>
          <td tooltip="popover"
              tooltip-placement="bottom"
              tooltip-title="${ _('Tiles X * Tiles Y') }"
              tooltip-content="{{row.tiles_in_x|number}} * {{row.tiles_in_y|number}}">
            <span class="pull-right">
              {{row.total_tiles | number}}
            </span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
%end

%rebase base_config leftblock=leftblock, middleblock=middleblock, rightblock=rightblock, preload_block=preload_block, project=get('project'), active='grids'
