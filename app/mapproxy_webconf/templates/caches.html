%def leftblock():
<div ng-controller="MapproxyCacheListCtrl">
    <button class="btn btn-small btn-info pull-right" ng-click="newCache()">
      <span class="icon-plus-sign icon-white" ></span>
      {{'Create new cache'|i18n}}</button>

    <h3>{{'Cache'|i18n}}</h3>
    <span class="text-error" id="cachelist_service_error" ng-show="false">
      <i class="icon-thumbs-down"></i>
      <strong>{{'An error occured'|i18n}}</strong>
      <p>{{cachelistErrorMsg}}</p>
    </span>
    <div>
      <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..."/>
      <br>
      <span ng-show="mapproxy_caches.length - filtered.length" ng-click="search=''">{{'Not shown caches'|i18n}}: {{mapproxy_caches.length - filtered.length}}</span>
    </div>
    <ul class="vertical-list">
      <hr>
      <div class="{{isSelected(cache)}}" ng-repeat="cache in filtered = (mapproxy_caches | filter:{data.name:search}) | orderBy:'name'"
      ng-click="editCache(cache)">
        <li>
          <i ng-show="cache._manual" class="icon-pencil"></i>
          {{cache.data.name}}
          <i ng-show="!hasDependencies(cache)" class="icon-remove"
             dialog="ask"
             dialog-title="{{'Confirm!'|i18n}}"
             dialog-text="{{'Really remove cache:'|i18n}} {{cache.data.name}}?"
             callback="removeCache(cache)">
          </i>
          <i ng-show="hasDependencies(cache)" class="icon-remove"
            dialog="confirm"
            dialog-width="600"
            dialog-height="300"
            dialog-title="Confirm!"
            dialog-text="{{'Can not remove cache:'|i18n}} {{cache.data.name}}<br>{{'Dependencies are:'|i18n}}<br>{{getDependencies(cache)}}">
          </i>
        </li>
        <hr>
      </div>
    </ul>
    <span ng-show="false">{{mapproxy_caches.length - filtered.length}}</span>
  </div>
%end

%def middleblock():
<div ng-controller="MapproxyCacheFormCtrl">
  <form name="cache_form" ng-model="cache" ng-show="!_editarea.visible">
    <h3>{{formTitle|i18n}}</h3>
    <!-- name -->
    <div labeled="input_label" name-for="cache_form.cache_name" text="{{'Name'|i18n}}">
        <input required class="input-xlarge" type="text" ng-model="cache.data.name" id="cache_form.cache_name"/>
    </div>
    <!-- sources -->
      <!-- change-callback MUST provide parameters callback and new_data -->
    <div labeled="input_label" name-for="cache_form.sources" text="{{'Sources'|i18n}}">
        <div
            droppable
            sortable
            required
            accepts="mapproxy_source"
            allow-array="true"
            ng-model="cache.data.sources"
            name="cache_form.sources"
            use-key-for-value="_id"
            class="input-xlarge insertable-list uneditable-input">
            <div ng-repeat="source in cache.data.sources" class="label">
                <span ng-bind="showName(source)"></span>
                <i class="icon-remove" ng-click="remove(source)"></i>
            </div>
        </div>
    </div>
    <div labeled="input_label" name-for="cache_form.grids" text="{{'Grids'|i18n}}">
        <select class="input-xlarge" ng-model="cache.data.grids" id="cache_form.grids" multiple="multiple" ng-options="value._id as value.data.name for value in available_grids"/>
        </select>
    </div>
    <div class="text-center">
      <span id="_editarea_toggle_button_container"></span>
      <button class="btn btn-small" ng-click="addCache($event)" ng-disabled="!cache_form.$valid" id="cache_form_save">{{'Save'|i18n}}</button>
      <button class="btn btn-small" ng-click="resetForm($event)">{{'Reset'|i18n}}</button>
    </div>
    <div class="text-center">
      <span class="text-success save_ok" ng-show="false">
        <br>
        <i class="icon-ok"></i>
         <strong>{{'Saved successfully'|i18n}}</strong>
      </span>
      <span class="text-error" id="cacheform_service_error" ng-show="false">
        <br>
        <i class="icon-thumbs-down"></i>
        <strong>{{'An error occured'|i18n}}</strong>
        <p>{{cacheformErrorMsg}}</p>
      </span>
    </div>
  </form>
  <div editarea editarea-value="{{prepareForEditarea(cache)}}" yaml-URL="/yaml" json-URL="/json" keep-empty-fields="name"></div>
</div>
%end

%def rightblock():
<div ng-controller="MapproxySourceListCtrl">
    <h3>{{'Sources'|i18n}}</h3>
    <div>
      <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..."/>
      <br>
      <span ng-show="mapproxy_sources.length - filtered.length" ng-click="search=''">{{'Not shown sources'|i18n}}: {{mapproxy_sources.length - filtered.length}}</span>
    </div>
    <ul class="vertical-list">
      <hr>
      <div draggable class="mapproxy_source" ng-repeat="source in filtered = (mapproxy_sources | filter:{data.name:search}) | orderBy:'name'"
          item-data="{{source}}">
        <li class="droppable_name">
            {{source.data.name}}
        </li>
        <hr>
      </div>
    </ul>
    <span ng-show="false">{{filtered.length}}</span>
    <span class="text-error" id="sourcelist_service_error" ng-show="false">
      <i class="icon-thumbs-down"></i>
      <strong>{{'An error occured'|i18n}}</strong>
      <p>{{sourcelistErrorMsg}}</p>
    </span>
</div>
%end

%rebase base_config leftblock=leftblock, rightblock=rightblock, middleblock=middleblock,  project=get('project'), active='caches'