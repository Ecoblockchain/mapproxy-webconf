%def leftblock():
  <div ng-controller="CacheListCtrl">
    <button class="btn btn-small btn-add pull-right" ng-click="newItem()">
      <span class="icon-plus-sign icon-white" ></span>
      {{'Create new cache'|i18n}}
    </button>

    <h3>{{'Cache'|i18n}}</h3>
    <span message-handler="success" message-types="caches.delete_success"></span>
    <span message-handler="error" message-types="caches.load_error,caches.delete_error"></span>
    <div>
      <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..." class="input-large"/>
      <br>
      <span ng-show="list.length - filtered.length" ng-click="search=''">
        {{'Not shown caches'|i18n}}: {{list.length - filtered.length}}
      </span>
    </div>
    <ul class="vertical-list">
      <div class="{{isSelected(item)}}"
           ng-repeat="item in filtered = (list | filter:{data.name:search}) | orderBy:'name'"
           ng-click="editItem($event, item)">
        <li>
          <i ng-show="item._manual" class="icon-pencil"></i>
          {{item.data.name}}
          <i ng-show="!hasDependencies(item)" class="icon-remove"
             dialog="ask"
             dialog-title="{{'Confirm!'|i18n}}"
             dialog-text="{{'Really remove cache:'|i18n}} {{item.data.name}}?"
             callback="removeItem($event, item)">
          </i>
          <i ng-show="hasDependencies(item)" class="icon-remove"
            dialog="confirm"
            dialog-width="600"
            dialog-height="300"
            dialog-title="Confirm!"
            dialog-text="{{'Can not remove cache:'|i18n}} {{item.data.name}}<br>{{'Dependencies are:'|i18n}}<br>{{getDependencies(item)}}">
          </i>
          <i class="icon-share" ng-click="copyItem($event, item)"></i>
        </li>
      </div>
    </ul>
    <span ng-show="false">{{mapproxy_caches.length - filtered.length}}</span>
  </div>
%end

%def middleblock():
  <div ng-controller="MapproxyCacheFormCtrl">
    <form name="form" ng-model="cache" ng-show="!editareaBinds.visible">
      <h3>{{formTitle|i18n}}</h3>
      <!-- name -->
      <div labeled="input_label" name-for="cache_name" text="{{'Name'|i18n}}">
          <input required class="input-xlarge" type="text" ng-model="cache.data.name" id="cache_name" name="cache_name"/>
      </div>
      <!-- sources -->
        <!-- change-callback MUST provide parameters callback and new_data -->
      <div labeled="input_label" name-for="sources" text="{{'Sources'|i18n}}">
        <div class="input-xlarge insertable-list uneditable-input"
             droppable
             sortable
             required
             accepts="mapproxy_source,mapproxy_cache"
             insert-callback="checkName(callback, new_item)"
             allow-array="true"
             ng-model="cache.data.sources"
             name="sources"
             id="sources"
             use-key-for-value="_id">
          <div ng-repeat="source in cache.data.sources" class="label">
            <span ng-bind="showName(source)"></span>
            <i class="icon-remove" ng-click="remove(source)"></i>
          </div>
        </div>
      </div>
      <div labeled="input_label" name-for="grids" text="{{'Grids'|i18n}}">
        <div class="input-xlarge insertable-list uneditable-input"
             droppable
             accepts="mapproxy_grid"
             ng-model="cache.data.grids"
             allow-array="true"
             name="grids"
             id="grids"
             use-key-for-value="_id">
          <div ng-repeat="grid in cache.data.grids" class="label">
            <span ng-bind="showName(grid)"></span>
            <i class="icon-remove" ng-click="remove(grid)"></i>
          </div>
        </div>
      </div>
      <hr>
      <div labeled='input_label_toggleable' text="{{'Format'|i18n}}">
        <div labeled="input_label" name-for="format" text="{{'Format'|i18n}}">
          <select class="input-xlarge" ng-model="cache.data.format" id="format" name="format">
            <option value="mixed">Mixed</option>
            <option value="image/png">Image/PNG</option>
            <option value="image/jpeg">Image/JPEG</option>
          </select>
        </div>
        <div labeled="input_label" name-for="request_format" text="{{'Request format'|i18n}}">
          <select class="input-xlarge" ng-model="cache.data.request_format" id="request_format" name="request_format">
            <option value="image/png">Image/PNG</option>
            <option value="image/jpeg">Image/JPEG</option>
          </select>
        </div>
      </div>
      <hr>
      <div class="pull-left">
        <button class="btn btn-small"
                ng-click="addCache($event)"
                ng-disabled="!form.$valid"
                id="form_save"
                ng-class="{'btn-success': form.$valid}">
          {{'Save'|i18n}}
        </button>
        <button class="btn btn-small" ng-click="resetForm($event)">{{'Reset'|i18n}}</button>
      </div>
      <div id="_editarea_toggle_button_container" class="pull-right"></div>
    </form>
    <div editarea="editareaBinds"
         yaml-URL="${get_url('json_to_yaml')}"
         json-URL="${get_url('yaml_to_json')}"
         keep-empty-fields="name">
    </div>
    <div class="clear">
      <span message-handler="success" message-types="caches.add_success,caches.update_success"></span>
      <span message-handler="error" message-types="caches.add_error,caches.update_error,caches.form_error"></span>
    </div>
  </div>
%end

%def rightblock():
  <div>
    <span ng-controller="SourceListCtrl">
      <h3>{{'Sources'|i18n}}</h3>
      <span message-handler="error" message-types="sources.load_error"></span>
      <div>
        <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..." class="input-large"/>
        <br>
        <span ng-show="list.length - filtered.length" ng-click="search=''">
          {{'Not shown sources'|i18n}}: {{list.length - filtered.length}}
        </span>
      </div>
      <ul class="vertical-list small">
        <div class="mapproxy_source"
             draggable
             ng-repeat="item in filtered = (list | filter:{data.name:search}) | orderBy:'name'"
             item-data="{{item}}">
          <li class="droppable_name">
            {{item.data.name}}
            <i class="icon-info-sign pull-right"
               dialog="confirm"
               dialog-title="{{'Informations'|i18n}}"
               dialog-height="300"
               dialog-text="{{getInfos(item)}}">
            </i>
          </li>
        </div>
      </ul>
      <span ng-show="false">{{filtered.length}}</span>
    </span>
    <hr>
    <span ng-controller="CacheListCtrl">
      <h3>{{'Caches'|i18n}}</h3>
      <span message-handler="error" message-types="caches.load_error"></span>
      <div>
        <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..." class="input-large"/>
        <br>
        <span ng-show="list.length - filtered.length"
              ng-click="search=''">
          {{'Not shown caches'|i18n}}: {{list.length - filtered.length}}
        </span>
      </div>
      <ul class="vertical-list small">
        <div class="mapproxy_cache"
             draggable
             ng-repeat="item in filtered = (list | filter:{data.name:search}) | orderBy:'name'"
             item-data="{{item}}">
          <li class="droppable_name">
            {{item.data.name}}
            <i class="icon-info-sign pull-right"
               dialog="confirm"
               dialog-title="{{'Informations'|i18n}}"
               dialog-height="300"
               dialog-text="{{getInfos(item)}}">
            </i>
          </li>
        </div>
      </ul>
      <span ng-show="false">{{filtered.length}}</span>
    </span>
    <hr>
    <div ng-controller="GridListCtrl">
      <h3>{{'Grids'|i18n}}</h3>
      <span message-handler="error" message-types="grids.load_error"></span>
      <div>
        <input type="text" ng-model="search" placeholder="{{'Filter'|i18n}}..." class="input-large"/>
        <br>
        <span ng-show="(list.concat(defaultGrids)).length - filtered.length"
              ng-click="search=''">
          {{'Not shown grids'|i18n}}: {{(list.concat(defaultGrids)).length - filtered.length}}
        </span>
      </div>
      <ul class="vertical-list small">
        <div class="mapproxy_grid"
             draggable
             ng-repeat="item in filtered = (list.concat(defaultGrids) | filter: {data.name:search}) | orderBy:'name'"
             item-data="{{item}}">
          <li class="droppable_name" ng-class="{'locked-grid': item._locked}">
            <i ng-show="item._locked || item.default" class="icon-ok"></i>
            <i ng-show="!item._locked && !item.default" class="icon-warning-sign"></i>
            {{item.data.name}}
            <i class="icon-info-sign pull-right"
               dialog="confirm"
               dialog-title="{{'Informations'|i18n}}"
               dialog-height="300"
               dialog-text="{{getInfos(item)}}">
            </i>
          </li>
        </div>
      </ul>
      <span ng-show="false">{{filtered.length}}</span>
    </div>
  </div>
%end

%rebase base_config leftblock=leftblock, rightblock=rightblock, middleblock=middleblock,  project=get('project'), language=get('language'), active='caches'